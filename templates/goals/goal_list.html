{% extends "base.html" %}

{% block content %}
  <h1>Your Study Goals</h1>

  <a href="{% url 'goals:create' %}" class="btn btn-primary mb-3">+ Add New Goal</a>

  {% if object_list %}
    <ul class="list-group">
      {% for goal in object_list %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <a href="{% url 'goals:detail' pk=goal.pk %}" class="fw-bold">
                {% if goal.course %}{{ goal.course.title }} â€“ {% endif %}
                {% if goal.milestone_name %}{{ goal.milestone_name }}{% else %}Goal {{ goal.id }}{% endif %}
              </a>

              <small class="text-muted d-block mt-1">
                {% if goal.weekly_hours_target %}
                  Weekly: {{ goal.weekly_hours_target }} hrs
                {% endif %}
                {% if goal.weekly_lessons_target %}
                  {% if goal.weekly_hours_target %} | {% endif %}
                  Lessons: {{ goal.weekly_lessons_target }} / wk
                {% endif %}
                {% if goal.total_required_lessons %}
                  {% if goal.weekly_hours_target or goal.weekly_lessons_target %} | {% endif %}
                  Milestone: {{ goal.total_required_lessons }} lessons
                  {% if goal.milestone_date %}(due {{ goal.milestone_date }}){% endif %}
                {% endif %}
              </small>

              <!-- Weekly progress bar -->
              {% if goal.weekly_hours_target %}
                {% with weekly=goal.weekly_progress_percent %}
                  <small class="text-muted d-block mt-1">
                    This week: {{ goal.weekly_study_hours }} / {{ goal.weekly_hours_target }} hrs
                  </small>
                  <div class="progress mt-1" style="height: 18px;">
                    <div class="progress-bar
                      {% if weekly >= 100 %}
                        bg-success
                      {% elif weekly >= 50 %}
                        bg-warning text-dark
                      {% else %}
                        bg-danger
                      {% endif %}"
                      role="progressbar"
                      style="width: {{ weekly }}%;"
                      aria-valuenow="{{ weekly }}" aria-valuemin="0" aria-valuemax="100">
                      Weekly: {{ weekly }}%
                    </div>
                  </div>
                {% endwith %}
              {% endif %}

              <!-- Overall progress bar -->
              {% with overall=goal.overall_progress_percent %}
                {% if overall %}
                  <small class="text-muted d-block mt-2">
                    Overall: {{ overall }}% complete toward milestone
                  </small>
                  <div class="progress mt-1" style="height: 18px;">
                    <div class="progress-bar bg-info text-dark"
                      role="progressbar"
                      style="width: {{ overall }}%;"
                      aria-valuenow="{{ overall }}" aria-valuemin="0" aria-valuemax="100">
                      Overall: {{ overall }}%
                    </div>
                  </div>
                {% endif %}
              {% endwith %}

              {% if goal.weekly_progress_percent >= 100 %}
                <small class="text-success fw-semibold d-block mt-2">âœ… Weekly goal complete!</small>
              {% endif %}
              {% if goal.overall_progress_percent and goal.overall_progress_percent >= 100 %}
                <small class="text-primary fw-semibold d-block mt-1">ðŸŒŸ Overall milestone achieved!</small>
              {% endif %}
            </div>

            <!-- Edit/Delete buttons -->
            <div class="ms-3 text-nowrap">
              <a href="{% url 'goals:edit' pk=goal.pk %}" class="btn btn-sm btn-outline-secondary me-2">Edit</a>
              <form action="{% url 'goals:delete' pk=goal.pk %}" method="post" style="display:inline"
                    onsubmit="return confirm('Are you sure you want to delete this goal?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger"
                        aria-label="Delete goal {{ goal.id }}">Delete</button>
              </form>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>You havenâ€™t set any goals yet.</p>
  {% endif %}
{% endblock %}
