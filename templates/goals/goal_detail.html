{% extends "base.html" %}

{% block content %}
  <h1>Goal Details</h1>

  <p><strong>Course:</strong> {{ goal.course }}</p>
  <p><strong>Weekly Hours Target:</strong> {{ goal.weekly_hours_target }}</p>
  <p><strong>Weekly Lessons Target:</strong> {{ goal.weekly_lessons_target }}</p>
  <p><strong>Study Days Per Week:</strong> {{ goal.study_days_per_week }}</p>

  {% if goal.daily_hours_target %}
    <p><strong>Daily Hours Target:</strong> {{ goal.daily_hours_target|floatformat:2 }}</p>
  {% endif %}
  {% if goal.daily_lessons_target %}
    <p><strong>Daily Lessons Target:</strong> {{ goal.daily_lessons_target|floatformat:2 }}</p>
  {% endif %}

  {% if goal.milestone_name %}
    <hr>
    <p><strong>Milestone:</strong> {{ goal.milestone_name }}
       {% if goal.milestone_date %}(due {{ goal.milestone_date }}){% endif %}</p>
    <p><strong>Total Required Lessons:</strong> {{ goal.total_required_lessons }}</p>
  {% endif %}

  <hr>

  <!-- === Progress Overview === -->
  {% with weekly=goal.weekly_progress_percent overall=goal.overall_progress_percent %}
    <h4>Progress Overview</h4>

    {% if weekly %}
      <p><strong>This week:</strong> {{ goal.weekly_study_hours }} / {{ goal.weekly_hours_target }} hrs</p>
      <div class="progress mb-3" style="height: 22px;">
        <div class="progress-bar
          {% if weekly >= 100 %}
            bg-success
          {% elif weekly >= 50 %}
            bg-warning text-dark
          {% else %}
            bg-danger
          {% endif %}"
          role="progressbar"
          style="width: {{ weekly }}%;"
          aria-valuenow="{{ weekly }}" aria-valuemin="0" aria-valuemax="100">
          Weekly: {{ weekly }}%
        </div>
      </div>
    {% endif %}

    {% if overall %}
      <p><strong>Overall progress:</strong> {{ overall }}% complete toward milestone</p>
      <div class="progress mb-3" style="height: 22px;">
        <div class="progress-bar bg-info text-dark"
          role="progressbar"
          style="width: {{ overall }}%;"
          aria-valuenow="{{ overall }}" aria-valuemin="0" aria-valuemax="100">
          Overall: {{ overall }}%
        </div>
      </div>
    {% endif %}

    {% if weekly >= 100 %}
      <div class="alert alert-success d-flex align-items-center" role="alert">
        <span class="me-2 fs-4">âœ…</span>
        <div><strong>Weekly goal complete!</strong> Great job keeping pace.</div>
      </div>
    {% endif %}
    {% if overall and overall >= 100 %}
      <div class="alert alert-info d-flex align-items-center" role="alert">
        <span class="me-2 fs-4">ðŸŒŸ</span>
        <div><strong>Milestone achieved!</strong> Youâ€™ve completed your overall goal!</div>
      </div>
    {% endif %}
  {% endwith %}

  {% if goal.projected_completion_date %}
  <span class="badge bg-light text-dark">
  ðŸ“… Projected finish: {{ goal.projected_completion_date|date:"j M Y" }}
  </span>
  {% endif %}

  <!-- Goal History -->
{% load static %}

<!-- Weekly Trend Chart -->
<section class="mt-4">
  <h2 class="h5 mb-3">Weekly Trend</h2>

  {% if chart_labels %}
    <div class="card">
      <div class="card-body">
        <!-- Container that stores the chart data for JavaScript -->
        <div id="chartData"
             data-labels='{{ chart_labels|safe }}'
             data-hours-completed='{{ chart_hours_completed|safe }}'
             data-hours-target='{{ chart_hours_target|safe }}'
             data-lessons-completed='{{ chart_lessons_completed|safe }}'
             data-lessons-target='{{ chart_lessons_target|safe }}'></div>

        <canvas id="goalTrendChart"></canvas>
      </div>
    </div>

    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Your static JavaScript file -->
    <script src="{% static 'goals/js/goal_chart.js' %}"></script>

  {% else %}
    <p class="text-muted">No weekly history yet â€” your chart will appear after your first frozen week.</p>
  {% endif %}
</section>


<!-- Goal History Table -->
<section class="mt-5">
  <h2 class="h5 mb-3">History</h2>

  {% if outcomes %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Week</th>
            <th class="text-end">Hours Completed</th>
            <th class="text-end">Target Hours</th>
            <th class="text-end">Lessons</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for outcome in outcomes %}
            <tr>
              <td>{{ outcome.week_start }} â€“ {{ outcome.week_end }}</td>
              <td class="text-end">{{ outcome.hours_completed }}</td>
              <td class="text-end">{{ outcome.hours_target|default:"â€”" }}</td>
              <td class="text-end">
                {{ outcome.lessons_completed }}/{{ outcome.lessons_target|default:"â€”" }}
              </td>
              <td>
                {% if outcome.completed %}
                  <span class="badge bg-success">Completed</span>
                {% else %}
                  <span class="badge bg-secondary">Incomplete</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No weekly history yet. Your progress will appear here after your first week of study.</p>
  {% endif %}
</section>


  <hr>

  <a href="{% url 'goals:edit' pk=goal.pk %}" class="btn btn-warning">Edit Goal</a>
  <form action="{% url 'goals:delete' pk=goal.pk %}" method="post" style="display:inline"
        onsubmit="return confirm('Delete this goal?');">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">Delete</button>
  </form>
  <a href="{% url 'goals:list' %}" class="btn btn-secondary">Back to Goals</a>
{% endblock %}