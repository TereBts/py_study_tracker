<!-- ============================================
  Template: goals/goal_detail.html
  Description: Displays detailed information, progress, and history
               for a specific Goal instance.
  ============================================ -->
{% extends "base.html" %}

{% block content %}
  <!-- ====== PAGE HEADER ====== -->
  <h1>Goal Details</h1>

  <!-- ====== GOAL INFORMATION ======
       Displays key data fields about the goal and its associated course. -->
  <p><strong>Course:</strong> {{ goal.course }}</p>
  <p><strong>Weekly Hours Target:</strong> {{ goal.weekly_hours_target }}</p>
  <p><strong>Weekly Lessons Target:</strong> {{ goal.weekly_lessons_target }}</p>
  <p><strong>Study Days Per Week:</strong> {{ goal.study_days_per_week }}</p>

  {% if goal.daily_hours_target %}
    <p><strong>Daily Hours Target:</strong> {{ goal.daily_hours_target|floatformat:2 }}</p>
  {% endif %}
  {% if goal.daily_lessons_target %}
    <p><strong>Daily Lessons Target:</strong> {{ goal.daily_lessons_target|floatformat:2 }}</p>
  {% endif %}

  <!-- ====== MILESTONE INFORMATION ======
       Shown only if the user defined a milestone. -->
  {% if goal.milestone_name %}
    <hr>
    <p><strong>Milestone:</strong> {{ goal.milestone_name }}
       {% if goal.milestone_date %}(due {{ goal.milestone_date }}){% endif %}</p>
    <p><strong>Total Required Lessons:</strong> {{ goal.total_required_lessons }}</p>
  {% endif %}

  <hr>

  <!-- ====== PROGRESS OVERVIEW ======
       Displays weekly and overall progress with progress bars and badges. -->
  {% with weekly=goal.weekly_progress_percent overall=goal.overall_progress_percent %}
    <h4>Progress Overview</h4>

    {% if weekly %}
      <!-- Weekly progress bar -->
      <p><strong>This week:</strong> {{ goal.weekly_study_hours }} / {{ goal.weekly_hours_target }} hrs</p>
      <div class="progress mb-3" style="height: 22px;">
        <div class="progress-bar
          {% if weekly >= 100 %}
            bg-success
          {% elif weekly >= 50 %}
            bg-warning text-dark
          {% else %}
            bg-danger
          {% endif %}"
          role="progressbar"
          style="width: {{ weekly }}%;"
          aria-valuenow="{{ weekly }}" aria-valuemin="0" aria-valuemax="100">
        </div>
      </div>
    {% endif %}

    {% if overall %}
      <!-- Overall milestone progress bar -->
      <p><strong>Overall progress:</strong> {{ overall }}% complete toward milestone</p>
      <div class="progress mb-3" style="height: 22px;">
        <div class="progress-bar bg-info text-dark"
          role="progressbar"
          style="width: {{ overall }}%;"
          aria-valuenow="{{ overall }}" aria-valuemin="0" aria-valuemax="100">
        </div>
      </div>
    {% endif %}

    <!-- Completion alerts -->
    {% if weekly >= 100 %}
      <div class="alert alert-success d-flex align-items-center" role="alert">
        <span class="me-2 fs-4">âœ…</span>
        <div><strong>Weekly goal complete!</strong> Great job keeping pace.</div>
      </div>
    {% endif %}
    {% if overall and overall >= 100 %}
      <div class="alert alert-info d-flex align-items-center" role="alert">
        <span class="me-2 fs-4">ðŸŒŸ</span>
        <div><strong>Milestone achieved!</strong> Youâ€™ve completed your overall goal!</div>
      </div>
    {% endif %}
  {% endwith %}

  <!-- ====== PROJECTED COMPLETION ======
       Displays a projected finish date if available. -->
  {% if goal.projected_completion_date %}
    <span class="badge bg-light text-dark">
      ðŸ“… Projected finish: {{ goal.projected_completion_date|date:"j M Y" }}
    </span>
  {% endif %}

  <!-- ====== WEEKLY TREND CHART ======
       Visualizes progress history over time using Chart.js. -->
  {% load static %}
  <section class="mt-4">
    <h2 class="h5 mb-3">Weekly Trend</h2>

    {% if chart_labels %}
      <div class="card">
        <div class="card-body">
          <canvas id="goalTrendChart" aria-label="Goal progress over time" role="img"></canvas>

          <!-- Inject chart data into JavaScript safely -->
          {{ chart_labels|json_script:"chart-labels" }}
          {{ chart_hours_completed|json_script:"chart-hours-completed" }}
          {{ chart_hours_target|json_script:"chart-hours-target" }}
          {{ chart_lessons_completed|json_script:"chart-lessons-completed" }}
          {{ chart_lessons_target|json_script:"chart-lessons-target" }}
        </div>
      </div>

      <!-- Include Chart.js library and custom script -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
      <script src="{% static 'goals/js/goal_chart.js' %}"></script>
    {% else %}
      <p class="text-muted">
        No weekly history yet â€” your chart will appear after your first frozen week.
      </p>
    {% endif %}
  </section>

  <!-- ====== GOAL HISTORY TABLE ======
       Displays all frozen weekly outcomes with completion status. -->
  <section class="mt-5">
    <h2 class="h5 mb-3">History</h2>

    {% if outcomes %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Week</th>
              <th class="text-end">Hours Completed</th>
              <th class="text-end">Target Hours</th>
              <th class="text-end">Lessons</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for outcome in outcomes %}
              <tr>
                <td>{{ outcome.week_start }} â€“ {{ outcome.week_end }}</td>
                <td class="text-end">{{ outcome.hours_completed }}</td>
                <td class="text-end">{{ outcome.hours_target|default:"â€”" }}</td>
                <td class="text-end">
                  {{ outcome.lessons_completed }}/{{ outcome.lessons_target|default:"â€”" }}
                </td>
                <td>
                  {% if outcome.completed %}
                    <span class="badge bg-success">Completed</span>
                  {% else %}
                    <span class="badge bg-secondary">Incomplete</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>No weekly history yet. Your progress will appear here after your first week of study.</p>
    {% endif %}
  </section>

  <hr>

  <!-- ====== ACTION BUTTONS ======
       Allows user to edit or delete the goal, or return to the list. -->
  <a href="{% url 'goals:edit' pk=goal.pk %}" class="btn btn-warning">Edit Goal</a>

  <form action="{% url 'goals:delete' pk=goal.pk %}" method="post" style="display:inline"
        onsubmit="return confirm('Delete this goal?');">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">Delete</button>
  </form>

  <a href="{% url 'goals:list' %}" class="btn btn-secondary">Back to Goals</a>
{% endblock %}
