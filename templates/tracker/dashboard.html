{% extends "base.html" %}
{% load static %}
{% load humanize %}
<!-- ============================================
  Template: tracker/dashboard.html
  Description: User dashboard showing weekly summary stats,
               recent sessions, achievements, and a monthly trend chart.
  Dependencies:
    - Extends base.html for layout & sidebar navigation.
    - Context variables:
        • recent_achievements, next_hours_hint
        • week_start, week_end
        • active_goals_count, total_hours_this_week
        • recent_sessions
        • monthly_labels_json, monthly_datasets_json
    - Static: js/dashboard_monthly_chart.js (Chart.js setup)
  ============================================ -->

{% block title %}Dashboard{% endblock %}

{% block content %}
  <div class="dashboard">

    <!-- ====== FLASH: RECENT ACHIEVEMENTS ======
         Shows newly unlocked achievements and the next hours hint. -->
    {% if recent_achievements %}
      <div class="alert alert-success">
        {% for ua in recent_achievements %}
          Unlocked: <strong>{{ ua.achievement.title }}</strong> ✨
          {% if not forloop.last %}<br>{% endif %}
        {% endfor %}
        {% if next_hours_hint %}
          <div class="small mt-1 text-muted">Next up: {{ next_hours_hint }}</div>
        {% endif %}
      </div>
    {% endif %}

    <!-- ====== PAGE HEADER ======
         Displays current week range and quick usage note. -->
    <header class="mb-3 d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-2">
      <div>
        <h1 class="h3 mb-1">Dashboard</h1>
        <p class="text-muted mb-0">
          This week: {{ week_start|date:"d M" }} – {{ week_end|date:"d M" }}
        </p>
      </div>
      <div class="text-muted small">
        Use the sidebar to navigate your tracker.
      </div>
    </header>

    <!-- ====== STAT CARDS ======
         Three concise KPI cards: Active Goals, Hours This Week, Achievements. -->
    <section class="row g-3 mb-4">

      <!-- Active Goals count -->
      <div class="col-12 col-md-4">
        <div class="card stat-card h-100">
          <div class="card-body">
            <p class="stat-label">Active Goals</p>
            <p class="stat-value">{{ active_goals_count }}</p>
          </div>
        </div>
      </div>

      <!-- Total hours logged during current week -->
      <div class="col-12 col-md-4">
        <div class="card stat-card h-100">
          <div class="card-body">
            <p class="stat-label">Hours This Week</p>
            <p class="stat-value">{{ total_hours_this_week }}</p>
            <p class="stat-subtle mb-0">Target dipping? Log a short session.</p>
          </div>
        </div>
      </div>

      <!-- Recently unlocked achievements + link -->
      <div class="col-12 col-md-4">
        <div class="card stat-card h-100">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <p class="stat-label mb-0">Achievements</p>
              <a href="{% url 'achievements:list' %}" class="btn btn-outline-primary btn-sm">View</a>
            </div>

            {% if recent_achievements %}
              <div class="dashboard-achievement-row mt-2">
                {% for ua in recent_achievements %}
                  <div class="dashboard-achievement-item text-center">
                    {% if ua.achievement.icon %}
                      <img
                        src="{% static 'images/achievements/badges/' %}{{ ua.achievement.icon }}"
                        alt="{{ ua.achievement.title }} badge"
                        class="badge-icon unlocked mb-1">
                    {% endif %}
                    <div class="small fw-semibold">{{ ua.achievement.title }}</div>
                    <div class="small text-muted">{{ ua.awarded_at|date:"j M" }}</div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted small mb-0">No badges yet. Log study to unlock your first one.</p>
            {% endif %}

            {% if next_hours_hint %}
              <p class="text-muted small mb-0 mt-1">{{ next_hours_hint }}</p>
            {% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- ====== MAIN CONTENT ROW ======
         Left: recent study sessions; Right: monthly trend chart. -->
    <section class="row g-4 mb-4">

      <!-- ---- Recent Study Sessions ---- -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header fw-semibold bg-body-tertiary">Recent Study Sessions</div>
          <ul class="list-group list-group-flush">
            {% for s in recent_sessions %}
              <li class="list-group-item list-item-hover d-flex justify-content-between align-items-center">
                <div class="me-3">
                  <div class="fw-semibold">{{ s.started_at|date:"d M Y" }}</div>
                  <div class="small text-muted">
                    {% if s.goal %}Goal: {{ s.goal }}{% endif %}
                    {% if s.course %}
                      {% if s.goal %} • {% endif %}
                      Course: {{ s.course }}
                    {% endif %}
                  </div>
                </div>
                <span class="badge rounded-pill text-bg-primary">{{ s.duration_minutes|default:0 }}m</span>
              </li>
            {% empty %}
              <li class="list-group-item text-muted">No sessions yet.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- ---- Monthly Trend Chart (Chart.js) ---- -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header fw-semibold bg-body-tertiary">Monthly Study Trend by Goal</div>
          <div class="card-body">
            <div class="dashboard-chart-wrapper">
              <!-- Data attributes are read by dashboard_monthly_chart.js -->
              <canvas
                id="monthlyTrendChart"
                class="dashboard-chart"
                data-labels='{{ monthly_labels_json|safe }}'
                data-datasets='{{ monthly_datasets_json|safe }}'>
              </canvas>
            </div>
            <p class="text-muted small mb-0 mt-2">Hours completed per month for each goal.</p>
          </div>
        </div>
      </div>

    </section>
  </div>
{% endblock %}

{% block extra_scripts %}
  <!-- ====== SCRIPTS ======
       Loads Chart.js and the dashboard chart initializer. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="{% static 'js/dashboard_monthly_chart.js' %}?v=4"></script>
{% endblock %}
